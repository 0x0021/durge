# Clash配置管理系统

## 功能概述

本系统实现了完整的Clash配置文件管理功能，包括：

1. **本地文件导入** - 从设备存储导入Clash配置文件
2. **独立文件夹存储** - 每个配置都有独立的文件夹
3. **数据库管理** - 使用Room数据库存储配置元数据
4. **配置激活/删除** - 支持配置的激活和完整删除
5. **默认配置** - 系统自动创建Default配置，确保始终有可用配置
6. **删除保护** - 不允许删除所有配置，至少保留一个配置

## 技术实现

### 数据库设计

- **ConfigEntity**: 配置实体类，包含配置的所有元数据
- **ConfigDao**: 数据访问对象，定义数据库操作
- **ConfigDatabase**: Room数据库类

### 文件管理

- **ConfigManager**: 核心配置管理器，处理文件操作和数据库交互
- **独立文件夹**: 每个配置使用UUID生成独一无二的文件夹名
- **文件验证**: 导入时验证Clash配置文件的有效性

### UI组件

- **ConfigViewModel**: 管理UI状态和业务逻辑
- **文件选择器**: 使用ActivityResultContracts.GetContent()选择文件
- **配置列表**: 显示所有配置，支持激活/删除操作

## 文件夹结构

```
/data/data/qialanfan.durge.doge/files/clash_configs/
├── config_[UUID1]/
│   └── config.yaml
├── config_[UUID2]/
│   └── config.yaml
└── ...
```

## 配置文件夹路径

配置根目录的绝对路径会在应用启动时记录到日志中，格式如下：

```
=== Clash配置管理系统路径信息 ===
配置根目录绝对路径: /data/data/qialanfan.durge.doge/files/clash_configs
应用内部存储路径: /data/data/qialanfan.durge.doge/files
配置根目录是否存在: true
现有配置文件夹数量: 2
配置文件夹: config_abc123 -> /data/data/qialanfan.durge.doge/files/clash_configs/config_abc123
  配置文件存在: true
  配置文件大小: 1024 bytes
=== 路径信息记录完成 ===
```

## 使用方法

### 默认配置

- 应用首次启动时会自动创建"Default"配置
- Default配置包含基本的Clash配置，可以直接使用
- 当前激活的配置名称会显示在启动页面和运行页面底部

### 导入配置

1. 打开应用，进入"主页"标签
2. 点击配置选择器（顶部显示当前激活配置名称的区域）
3. 在弹出的配置列表中，创建选项按以下顺序排列：
   - 从本地文件导入
   - 下载配置
   - 创建当前配置副本
4. 点击"从本地文件导入"选择Clash配置文件（.yaml或其他格式）
5. 系统会自动使用原始文件名作为配置名称（去除扩展名）
6. 系统会自动验证并导入配置
7. **自动激活**：导入成功后会自动激活新配置，无需手动选择

### 管理配置

1. 点击配置选择器打开配置列表弹窗
2. 在弹窗中点击配置项会显示选中状态，但不会立即关闭弹窗
3. 用户可以看到选择效果，通过"完成"按钮确认并关闭弹窗
4. 关闭弹窗时会自动激活选中的配置
5. 在配置列表中，每个配置项右侧有"更多操作"按钮（仅在可以删除时显示）
6. 点击"更多操作"可以选择"删除配置"
7. 删除配置会同时删除文件夹和数据库记录
8. **智能UI**：当只有一个配置时，不显示删除选项，避免用户误操作
9. **重要**：系统不允许删除所有配置，至少会保留一个配置

### 配置验证

系统会验证导入的文件是否为有效的Clash配置，检查以下关键字段：
- `proxies`
- `proxy-groups`
- `rules`
- `port`
- `socks-port`

## 数据安全

- 所有配置文件存储在应用私有目录中，其他应用无法访问
- 每个配置使用UUID生成唯一文件夹名，避免冲突
- 删除配置时会完全清理文件夹和数据库记录
- 支持配置文件的完整性验证

## 扩展功能

系统预留了以下扩展接口：
- 从URL下载配置
- 创建配置副本
- 配置重命名
- 文本模式编辑
- 外部资源管理

## 获取配置路径

可以通过以下方式获取配置文件夹的绝对路径：

```kotlin
// 获取配置根目录路径
val rootPath = configViewModel.getConfigsRootPath()

// 获取特定配置的文件夹路径
val configPath = configViewModel.getConfigFolderPath(configId)
```

## 注意事项

1. 配置文件夹名称使用UUID确保唯一性
2. 删除配置会永久删除文件，请谨慎操作
3. 导入的配置文件会被复制到应用私有目录
4. 系统会在应用启动时自动创建配置根目录和默认配置
5. 所有数据库操作都在后台线程执行，不会阻塞UI
6. **删除保护**：系统不允许删除所有配置，确保始终有至少一个可用配置
7. 删除激活配置时，系统会自动激活其他配置
8. UI已清理所有占位符，显示真实的配置数据
9. **智能UI**：只有一个配置时自动隐藏删除选项，提供更好的用户体验
10. **简洁界面**：移除了激活状态显示，点击配置项直接激活，界面更简洁
11. **智能命名**：导入配置时自动使用原始文件名，保持文件的原始标识
12. **自动激活**：导入配置后自动激活，提供无缝的用户体验
13. **友好选择**：配置选择时显示选中状态而不立即关闭弹窗，用户可以确认选择 
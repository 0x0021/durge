# 文件位置：.github/workflows/gradle.yml
name: 编译项目

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build on Ubuntu
    runs-on: ubuntu-latest

    steps:
      # 获取代码
      - name: 🛎️ Checkout code
        uses: actions/checkout@v4

      # 设置 JDK 版本（可按需修改）
      - name: ☕ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # 缓存 Gradle 以提升速度
      - name: 🗂️ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.kts', '**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 添加执行权限
      - name: 🔧 Make gradlew executable
        run: chmod +x ./gradlew

      # 检查 .aar 是否存在，避免构建失败
      - name: 🔍 Check durgecore.aar exists
        run: |
          if [ ! -f "./app/src/main/mihomo/durgecore.aar" ]; then
            echo "❌ durgecore.aar 文件缺失！"
            echo "📦 请把文件放入 app/src/main/mihomo/ 并提交到 Git 仓库。"
            exit 1
          else
            echo "✅ durgecore.aar 存在，准备构建。"
          fi

      # 构建任务
      - name: 🚀 Build with Gradle
        run: ./gradlew build --no-daemon
